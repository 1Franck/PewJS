/*! build 2015-01-01 12:01:37 */
/*! Pew.js */
/*! Copyright Francois Lajoie */
/*! MIT License */
"use strict";var Pew=function(){function a(a){var b={title:"My Project",fps:60,resources:[],vars:{}};return this.conf=Pew.utils.extend({},b,a),this.scenes={},this.layers={},this.anim_frame=new AnimationFrame(this.conf.fps),this}function b(a){var b=a||{};return this.fullscreen=void 0===b.fullscreen?!1:b.fullscreen,this.autoresize=void 0===b.autoresize?!1:b.autoresize,this.container=b.container||"document",this.class=b.class||"",this.width=b.width||window.innerWidth,this.height=b.height||window.innerHeight,this.canvas=b.canvas||null,this.ctx=b.ctx||null,this.init(),this}function c(a,b){return this.fn=b||function(){},function(){this._name=a,this._fid=0,this._status="idle",this.is=function(a){return this._status===a?!0:!1},this.requestAnim=function(a){var a=a||this.draw;this._fid=Pew.project().anim_frame.request(a),this._status="playing"},this.cancelAnim=function(){Pew.project().anim_frame.cancel(this._fid),this._status="idle"},this.toggleAnim=function(a){if(this.is("idle")){var a=a||this.draw;a()}else this.cancelAnim()}}.apply(this.fn),this}{var d;!function(){var a=1e3;return{get:function(){return++a}}}()}return{Project:a,Scene:c,Layer:b,project:function(){return d},createProject:function(b){return d=new a(b)}}}();Pew.Scene.prototype.start=function(){this.fn.start&&this.fn.start(),this.fn.draw&&this.fn.draw()},Pew.Scene.prototype.stop=function(){this.fn.cancelAnim()},Pew.Layer.prototype.init=function(){if(null==this.canvas&&(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),"document"===this.container?document.body.appendChild(this.canvas):document.querySelector(this.container).appendChild(this.canvas)),this.class.length>0&&this.canvas.setAttribute("class",this.class),this.canvas.style.display="block",this.canvas.style.position="absolute",this.canvas.style.zIndex=this._zi.get(),this.fullscreen===!0?this.requestFullscreen():(this.canvas.width=this.width,this.canvas.height=this.height),this.autoresize){window.onresize=window.onresize||function(){for(var a in Pew.project().layers)Pew.project().layers[a].autoresize&&(Pew.project().layers[a].canvas.width=window.innerWidth,Pew.project().layers[a].canvas.height=window.innerHeight,Pew.project().layers[a].width=Pew.project().layers[a].canvas.width,Pew.project().layers[a].height=Pew.project().layers[a].canvas.height)}}},Pew.Layer.prototype.requestFullscreen=function(){var a=document.documentElement;a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.msRequestFullscreen&&a.msRequestFullscreen(),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.width=this.canvas.width,this.height=this.canvas.height},Pew.Layer.prototype.clear=function(a,b,c,d){var a=a||0,b=b||0,c=c||this.canvas.width,d=d||this.canvas.height;this.ctx.clearRect(a,b,c,d)},Pew.Layer.prototype._zi=function(){var a=0;return{get:function(){return++a}}}(),Pew.Project.prototype.createLayer=function(a,b){var c=new Pew.Layer(b);return this.layers[a]=c,c},Pew.Project.prototype.destroyLayer=function(a){this.layers.hasOwnProperty(a)&&(void 0==this.layers[a].canvas.remove?this.layers[a].canvas.style.display="none":this.layers[a].canvas.remove(),delete this.layers[a])},Pew.Project.prototype.destroyLayers=function(){for(var a in this.layers)this.destroyLayer(a)},Pew.Project.prototype.createScene=function(a,b){return this.scenes[a]=new Pew.Scene(a,b),this.scenes[a]},Pew.Project.prototype.startScene=function(a){this.scenes[a].start()},Pew.Project.prototype.stopScene=function(a){this.scenes[a].stop()},Pew.Project.prototype.mouse=function(){function a(a){for(var b=a.offsetLeft,c=a.offsetTop,d=a.offsetParent;null!==d;)b=parseInt(b)+parseInt(d.offsetLeft),c=parseInt(c)+parseInt(d.offsetTop),d=d.offsetParent;return new Array(b,c)}function b(b){var b=b||null;null!=b&&(b.addEventListener("click",function(a){c.click=!0,d.click&&d.click(a),c.click=!1}),b.addEventListener("dblclick",function(a){c.dblclick=!0,d.dblclick&&d.dblclick(a),c.dblclick=!1}),b.addEventListener("mousedown",function(a){c.mousedown=!0,d.mousedown&&d.mousedown(a),c.mousedown=!1}),b.addEventListener("mouseup",function(a){c.mouseup=!0,d.mouseup&&d.mouseup(a),c.mouseup=!1}),b.addEventListener("mousemove",function(c){var d=a(b);e.x=c.clientX-d[0],e.y=c.clientY-d[1]}))}var c=[],d=[],e={x:0,y:0};return{init:b,cursor:e,x:function(a){return e.x=a||e.x,e.x},y:function(a){return e.y=a||e.y,e.y},on:function(a,b){d[a]=b},off:function(a){d.splice(a,1)}}}(),Pew.Project.prototype.keyboard=function(){function a(){document.body.addEventListener("keydown",function(a){f[a.keyCode]=!0;var c=h(a,e(a.keyCode));c!==!1&&g[a.keyCode]&&(b(a.keyCode),a.preventDefault())}),document.body.addEventListener("keyup",function(a){f[a.keyCode]=!1})}function b(a){var b=c(a);g[b]&&g[b](e(b))}function c(a){if(isNaN(a)){var a=i[a.toUpperCase()]||a;isNaN(a)&&(a=a.toUpperCase().charCodeAt(0))}return a}function d(a){if(isNaN(a))return a;for(var b in i)if(i[b]==a)return b;return String.fromCharCode(a)}function e(a){return{"char":d(a).toLowerCase(),code:a}}for(var f=[],g={},h=function(){},i={SHIFT:16,TAB:9,CTRL:17,ALT:18,SPACE:32,BACKSPACE:8,ENTER:13,ESC:27,LEFT:37,RIGHT:39,UP:38,DOWN:40},j=1;13>j;++j)i["F"+j]=111+j;return{init:a,toKeyCode:c,toKeyChar:d,trigger:b,key:function(a){return a=c(a),void 0===f[a]&&(f[a]=!1),f[a]},keys:function(){var a=[];for(var b in f)0!=f[b]&&a.push(b);return a},on:function(a,b){if("[object Array]"===Object.prototype.toString.call(a))for(var d in a)g[c(a[d])]=b;else g[c(a)]=b},off:function(a){if(void 0!==a)if("[object Array]"===Object.prototype.toString.call(a))for(var b in a)delete g[c(a[b])];else delete g[c(a)];else for(var a in g)delete g[a]},onAll:function(a){h=a},offAll:function(){h=function(){}}}}(),Pew.Project.prototype.resources=function(){function a(a,b){this.url=a,this.rid=b,this.ready=!1,this.el=!1;var c=a.split(".");this.ext=1===c.length||""===c[0]&&2===c.length?"":c.pop()}function b(b,c,g){c=c||function(){},g=g||function(){},f.push(c);var h=f.length-1;Pew.utils.isArray(b)||(b=[b]),g(d(h)),b.forEach(function(b){var d=new a(b.src,h);if("image"===d.type())d.el=new Image;else{if("audio"!==d.type())return;d.el=new Audio}d.onLoad(c,g),d.el.src=b.src,e[b.name]=d})}function c(a){var b=!0;for(var c in e)e[c].ready===!1&&e[c].rid===a&&(b=!1);return b}function d(a){var b=0,c=0;for(var d in e)e[d].rid===a&&(e[d].ready===!1?++c:++b);return{total:b+c,ready:b,not_ready:c,progress:Math.round(100*b/(b+c))||0}}var e={},f=[],g={audio:["mp3","m4a","ogg","oga","webma","wav"],image:["jpg","jpeg","png","gif"]};return a.prototype.type=function(){for(var a in g)for(var b in g[a])if(g[a][b]===this.ext)return a},a.prototype.onLoad=function(a,b){var e=this;this.el.addEventListener("load",function(){e.ready=!0;var g=d(e.rid);c(e.rid)?(b(g),a(),f[e.rid]=function(){}):b(g)})},{load:b,get:function(a){return e[a].el}}}(),Pew.Project.prototype.sprites=function(){function a(a){var b={resource:"",clip:{w:0,h:0},frameset:[]};return this.conf=Pew.utils.extend({},b,a),this.frames=[],this.to_radians=Math.PI/180,"string"==typeof this.conf.resource&&(this.conf.resource=Pew.project().resources.get(this.conf.resource)),this.conf.clip.w>0&&this.conf.clip.h>0&&this.clip(this.conf.clip.w,this.conf.clip.h),this}function b(a,b){var c={duration:500,frames:[],loop:!0};if(this.conf=Pew.utils.extend({},c,a),"all"===this.conf.frames){this.conf.frames=[];for(var d=0;b>d;++d)this.conf.frames.push(d)}this.ticks=Pew.project().anim_frame.frameRate*(this.conf.duration/1e3),this.tick_index=0,this.cur_frame=0,this.fpt=Math.round(this.ticks/this.conf.frames.length)}return a.prototype.clip=function(a,b){this.frames=[],this.conf.clip.w=Math.round(a),this.conf.clip.h=Math.round(b);for(var c=this.conf.resource.width,d=this.conf.resource.height,e=Math.ceil(c/a),f=Math.ceil(d/b),g=0;f>g;++g)for(var h=0;e>h;++h)this.frames.push({x:this.conf.clip.w*h,y:this.conf.clip.h*g,w:a,h:b,cx:this.conf.clip.w/2,cy:this.conf.clip.h/2})},a.prototype.framesIndexMap=function(a,b,c){b=b||0,c=c||0;var d=a.ctx.font;a.ctx.font="12px monospace";for(var e=0;e<this.frames.length;++e)this.drawFrame(e,a,this.frames[e].x,this.frames[e].y),a.ctx.beginPath(),a.ctx.globalAlpha=.4,a.ctx.rect(this.frames[e].x,this.frames[e].y+this.frames[e].h/2-10,50,13),a.ctx.fillStyle="#fff",a.ctx.fill(),a.ctx.globalAlpha=1,a.ctx.fillStyle="#000",a.ctx.fillText(e,this.frames[e].x+this.frames[e].w/2,this.frames[e].y+this.frames[e].h/2);a.ctx.font=d},a.prototype.getFrame=function(a){var b=this.frames[a];return b},a.prototype.getFrames=function(){},a.prototype.drawFrame=function(a,b,c,d,e){var f=this.frames[a];if(void 0!==f){var g=this.conf.resource;void 0!==e?(g=this.preRender(f,e),b.ctx.drawImage(g,c,d)):b.ctx.drawImage(g,f.x,f.y,f.w,f.h,c+f.cx,d+f.cy,f.w,f.h)}return this},a.prototype.preRender=function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d"),e=new Image,f=b*this.to_radians;return c.width=2*a.w,c.height=2*a.h,d.translate(a.w,a.h),d.rotate(f),d.drawImage(this.conf.resource,a.x,a.y,a.w,a.h,-1*a.cx,-1*a.cy,a.w,a.h),e.src=c.toDataURL("image/png"),e},a.prototype.createAnim=function(a){return new b(a,this.frames.length)},b.prototype.loop=function(){this.tick_index>this.fpt&&(this.tick_index=0,++this.cur_frame),this.cur_frame>this.conf.frames.length-1&&(this.conf.loop===!1?--this.cur_frame:this.cur_frame=0),++this.tick_index},b.prototype.getFrame=function(){return this.loop(),this.conf.frames[this.cur_frame]},{create:function(b){return new a(b)}}}(),Pew.Project.prototype.fpsmeter=function(){function a(a){a||(a={}),this.updateRate=a.updateRate||1e3,this._tickCounter=0,this._updateTimeoutId=null,this.current=0}var b=Date.now||function(){return(new Date).getTime()};return a.prototype.start=function(a){var c=this;return a=a||function(){},this._startTime=b(),this._tickCounter=0,this._updateTimeoutId=setTimeout(function(){c._tickCounter&&(c.current=Math.round(1e3/((b()-c._startTime)/c._tickCounter)),a(c.current)),c.start(a)},this.updateRate),this},a.prototype.stop=function(){return clearTimeout(this._updateTimeoutId),this},a.prototype.tick=function(){return++this._tickCounter,this},new a}(),Pew.utils=function(){},Pew.utils.deepExtend=function(a){a=a||{};for(var b=1;b<arguments.length;b++){var c=arguments[b];if(c)for(var d in c)c.hasOwnProperty(d)&&("object"==typeof c[d]?Pew.utils.extend(a[d],c[d]):a[d]=c[d])}return a},Pew.utils.extend=function(a){a=a||{};for(var b=1;b<arguments.length;b++){var c=arguments[b];if(c)for(var d in c)c.hasOwnProperty(d)&&(a[d]=c[d])}return a},Pew.utils.rand=function(a,b,c){return c=c||1,Math.round((Math.floor(Math.random()*(b-a+1))+a)/c)*c},Pew.utils.randIndex=function(a){return a[this.rand(1,a.length)-1]},Pew.utils.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);d>e;)f[e++]=a,a+=c;return f},Pew.utils.isRangeStr=function(a){return a.match(/([0-9]+)..([0-9]+)/gi)},Pew.utils.isArray=function(a){return"[object Array]"==Object.prototype.toString.call(a)},function(a){function b(a){return this instanceof b?(a||(a={}),"number"==typeof a&&(a={frameRate:a}),null!=a.useNative||(a.useNative=!0),this.options=a,this.frameRate=a.frameRate||b.FRAME_RATE,this._frameLength=1e3/this.frameRate,this._isCustomFrameRate=this.frameRate!==b.FRAME_RATE,this._timeoutId=null,this._callbacks={},this._lastTickTime=0,void(this._tickCounter=0)):new b(a)}var c,d;!function(){var e,f,g=["webkit","moz","ms","o"];try{a.top.name,f=a.top}catch(h){f=a}for(c=f.requestAnimationFrame,d=f.cancelAnimationFrame||f.cancelRequestAnimationFrame,e=0;e<g.length&&!c;e++)c=f[g[e]+"RequestAnimationFrame"],d=f[g[e]+"CancelAnimationFrame"]||f[g[e]+"CancelRequestAnimationFrame"];c&&c(function(){b.hasNative=!0})}(),b.FRAME_RATE=60,b.shim=function(c){var d=new b(c);return a.requestAnimationFrame=function(a){return d.request(a)},a.cancelAnimationFrame=function(a){return d.cancel(a)},d},b.now=Date.now||function(){return(new Date).getTime()},b.navigationStart=b.now(),b.perfNow=function(){return a.performance&&a.performance.now?a.performance.now():b.now()-b.navigationStart},b.hasNative=!1,b.prototype.request=function(d){var e,f=this;if(++this._tickCounter,b.hasNative&&f.options.useNative&&!this._isCustomFrameRate)return c(d);if(!d)throw new TypeError("Not enough arguments");return null==this._timeoutId&&(e=this._frameLength+this._lastTickTime-b.now(),0>e&&(e=0),this._timeoutId=a.setTimeout(function(){var a;f._lastTickTime=b.now(),f._timeoutId=null,++f._tickCounter;for(a in f._callbacks)f._callbacks[a]&&(b.hasNative&&f.options.useNative?c(f._callbacks[a]):f._callbacks[a](b.perfNow()),delete f._callbacks[a])},e)),this._callbacks[this._tickCounter]=d,this._tickCounter},b.prototype.cancel=function(a){b.hasNative&&this.options.useNative&&d(a),delete this._callbacks[a]},"object"==typeof exports&&"object"==typeof module?module.exports=b:"function"==typeof define&&define.amd?define(function(){return b}):a.AnimationFrame=b}(window);